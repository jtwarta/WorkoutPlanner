<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0a">
<title>Workout Advisor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0a;
  --surface: #141414;
  --surface2: #1c1c1c;
  --border: #2a2a2a;
  --text: #e8e8e8;
  --text-dim: #777;
  --accent: #4ade80;
  --accent-dim: rgba(74, 222, 128, 0.15);
  --warn: #fb923c;
  --warn-dim: rgba(251, 146, 60, 0.15);
  --danger: #f87171;
  --danger-dim: rgba(248, 113, 113, 0.15);
  --blue: #60a5fa;
  --blue-dim: rgba(96, 165, 250, 0.15);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.mono { font-family: 'JetBrains Mono', monospace; }

/* Layout */
.app { max-width: 480px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border);
}
.header h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
.header .subtitle { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.header-right { text-align: right; }

/* Cards */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}
.card-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  margin-bottom: 12px;
}

/* Today's recommendation */
.rec-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.rec-item:last-child { border-bottom: none; }
.rec-rank {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 700;
  color: var(--accent);
  width: 24px;
  text-align: center;
}
.rec-info { flex: 1; }
.rec-name { font-size: 14px; font-weight: 600; }
.rec-detail { font-size: 11px; color: var(--text-dim); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }
.rec-urgency {
  font-size: 10px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 6px;
  font-family: 'JetBrains Mono', monospace;
}
.urgency-high { background: var(--danger-dim); color: var(--danger); }
.urgency-med { background: var(--warn-dim); color: var(--warn); }
.urgency-low { background: var(--accent-dim); color: var(--accent); }

/* Muscle group grid */
.muscle-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.muscle-cell {
  background: var(--surface2);
  border-radius: 8px;
  padding: 10px;
}
.muscle-name { font-size: 12px; font-weight: 600; }
.muscle-stat { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-top: 4px; }
.muscle-bar {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.muscle-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

/* Weight chart */
.weight-chart {
  width: 100%;
  height: 120px;
  position: relative;
}
.weight-chart canvas { width: 100%; height: 100%; }
.weight-current {
  font-family: 'JetBrains Mono', monospace;
  font-size: 28px;
  font-weight: 700;
}
.weight-delta {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  margin-left: 8px;
}

/* Setup screen */
.setup {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  text-align: center;
  gap: 16px;
}
.setup h2 { font-size: 22px; font-weight: 700; }
.setup p { font-size: 13px; color: var(--text-dim); max-width: 300px; line-height: 1.5; }
.setup input {
  width: 100%;
  max-width: 320px;
  padding: 12px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  outline: none;
}
.setup input:focus { border-color: var(--accent); }
.btn {
  padding: 12px 24px;
  background: var(--accent);
  color: #0a0a0a;
  border: none;
  border-radius: 8px;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s;
}
.btn:active { opacity: 0.8; }
.btn-small {
  padding: 6px 12px;
  font-size: 11px;
  background: var(--surface2);
  color: var(--text-dim);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
}

/* Loading */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  gap: 16px;
}
.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 12px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

/* Error */
.error-msg {
  background: var(--danger-dim);
  border: 1px solid rgba(248,113,113,0.3);
  border-radius: 8px;
  padding: 12px;
  font-size: 12px;
  color: var(--danger);
  margin-bottom: 12px;
}

/* Recent workouts */
.workout-item {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.workout-item:last-child { border-bottom: none; }
.workout-title { font-size: 13px; font-weight: 600; }
.workout-meta { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
  background: var(--surface);
  border-radius: 10px;
  padding: 3px;
}
.tab {
  flex: 1;
  padding: 8px;
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  color: var(--text-dim);
  transition: all 0.2s;
  border: none;
  background: none;
  font-family: 'DM Sans', sans-serif;
}
.tab.active { background: var(--surface2); color: var(--text); }

/* Refresh indicator */
.refresh-bar {
  font-size: 10px;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
  text-align: center;
  padding: 8px 0;
  margin-bottom: 8px;
}

.hidden { display: none; }
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Setup Screen -->
  <div id="setup-screen" class="setup">
    <h2>Workout Advisor</h2>
    <p>Enter your Hevy API key to get started. You can find it at hevy.com/settings under Developer.</p>
    <input type="text" id="api-key-input" placeholder="your-api-key-here" autocomplete="off">
    <button class="btn" onclick="saveApiKey()">Connect</button>
    <div id="setup-error" class="error-msg hidden"></div>
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen" class="loading hidden">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Connecting to Hevy...</div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden">
    <div class="header">
      <div>
        <h1>Workout Advisor</h1>
        <div class="subtitle" id="last-updated"></div>
      </div>
      <div class="header-right">
        <button class="btn-small" onclick="refreshData()">↻ refresh</button>
        <button class="btn-small" onclick="resetApp()" style="margin-left:4px;">⚙</button>
      </div>
    </div>

    <div id="error-area"></div>

    <div class="tabs">
      <button class="tab active" data-tab="today" onclick="switchTab('today')">Today</button>
      <button class="tab" data-tab="muscles" onclick="switchTab('muscles')">Muscles</button>
      <button class="tab" data-tab="history" onclick="switchTab('history')">History</button>
      <button class="tab" data-tab="weight" onclick="switchTab('weight')">Weight</button>
    </div>

    <!-- Today Tab -->
    <div id="tab-today">
      <div class="card">
        <div class="card-title">Recommended Training</div>
        <div id="recommendations"></div>
      </div>
      <div class="card">
        <div class="card-title">Suggested Exercises</div>
        <div id="suggested-exercises"></div>
      </div>
    </div>

    <!-- Muscles Tab -->
    <div id="tab-muscles" class="hidden">
      <div class="card">
        <div class="card-title">Muscle Group Status</div>
        <div id="muscle-grid" class="muscle-grid"></div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="tab-history" class="hidden">
      <div class="card">
        <div class="card-title">Recent Workouts</div>
        <div id="recent-workouts"></div>
      </div>
    </div>

    <!-- Weight Tab -->
    <div id="tab-weight" class="hidden">
      <div class="card">
        <div class="card-title">Body Weight</div>
        <div style="display:flex;align-items:baseline;margin-bottom:16px;">
          <span class="weight-current" id="weight-current">--</span>
          <span class="weight-delta" id="weight-delta"></span>
          <span style="font-size:12px;color:var(--text-dim);margin-left:4px;">lbs</span>
        </div>
        <div class="weight-chart">
          <canvas id="weight-canvas"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// EXERCISE → MUSCLE GROUP MAPPING
// ============================================================
// Primary and secondary muscle groups for common exercises.
// Exercise names are matched case-insensitively via substring.
const EXERCISE_MUSCLE_MAP = [
  // Chest
  { pattern: /bench press/i, primary: 'chest', secondary: ['triceps', 'shoulders'] },
  { pattern: /chest press/i, primary: 'chest', secondary: ['triceps', 'shoulders'] },
  { pattern: /chest fly/i, primary: 'chest', secondary: [] },
  { pattern: /chest dip/i, primary: 'chest', secondary: ['triceps', 'shoulders'] },
  { pattern: /cable fly/i, primary: 'chest', secondary: [] },
  { pattern: /push.?up/i, primary: 'chest', secondary: ['triceps', 'shoulders'] },
  { pattern: /pec.?deck/i, primary: 'chest', secondary: [] },
  { pattern: /dip/i, primary: 'chest', secondary: ['triceps', 'shoulders'] },

  // Back
  { pattern: /deadlift/i, primary: 'back', secondary: ['hamstrings', 'glutes'] },
  { pattern: /pull.?up/i, primary: 'back', secondary: ['biceps'] },
  { pattern: /chin.?up/i, primary: 'back', secondary: ['biceps'] },
  { pattern: /lat.?pull/i, primary: 'back', secondary: ['biceps'] },
  { pattern: /row/i, primary: 'back', secondary: ['biceps'] },
  { pattern: /rack pull/i, primary: 'back', secondary: ['hamstrings'] },
  { pattern: /back extension/i, primary: 'back', secondary: ['glutes'] },
  { pattern: /good morning/i, primary: 'back', secondary: ['hamstrings', 'glutes'] },
  { pattern: /shrug/i, primary: 'back', secondary: [] },
  { pattern: /face pull/i, primary: 'back', secondary: ['shoulders'] },

  // Shoulders
  { pattern: /overhead press/i, primary: 'shoulders', secondary: ['triceps'] },
  { pattern: /shoulder press/i, primary: 'shoulders', secondary: ['triceps'] },
  { pattern: /military press/i, primary: 'shoulders', secondary: ['triceps'] },
  { pattern: /arnold press/i, primary: 'shoulders', secondary: ['triceps'] },
  { pattern: /lateral raise/i, primary: 'shoulders', secondary: [] },
  { pattern: /front raise/i, primary: 'shoulders', secondary: [] },
  { pattern: /rear delt/i, primary: 'shoulders', secondary: [] },
  { pattern: /upright row/i, primary: 'shoulders', secondary: ['back'] },
  { pattern: /pike push/i, primary: 'shoulders', secondary: ['triceps'] },

  // Biceps
  { pattern: /bicep curl/i, primary: 'biceps', secondary: [] },
  { pattern: /hammer curl/i, primary: 'biceps', secondary: [] },
  { pattern: /concentration curl/i, primary: 'biceps', secondary: [] },
  { pattern: /preacher curl/i, primary: 'biceps', secondary: [] },
  { pattern: /barbell curl/i, primary: 'biceps', secondary: [] },

  // Triceps
  { pattern: /tricep/i, primary: 'triceps', secondary: [] },
  { pattern: /skull.?crush/i, primary: 'triceps', secondary: [] },
  { pattern: /close.?grip.*bench/i, primary: 'triceps', secondary: ['chest'] },

  // Quads
  { pattern: /squat/i, primary: 'quads', secondary: ['glutes', 'hamstrings'] },
  { pattern: /leg press/i, primary: 'quads', secondary: ['glutes'] },
  { pattern: /leg extension/i, primary: 'quads', secondary: [] },
  { pattern: /lunge/i, primary: 'quads', secondary: ['glutes', 'hamstrings'] },
  { pattern: /goblet squat/i, primary: 'quads', secondary: ['glutes'] },
  { pattern: /front squat/i, primary: 'quads', secondary: ['glutes'] },
  { pattern: /step.?up/i, primary: 'quads', secondary: ['glutes'] },
  { pattern: /hack squat/i, primary: 'quads', secondary: ['glutes'] },

  // Hamstrings
  { pattern: /romanian deadlift/i, primary: 'hamstrings', secondary: ['glutes', 'back'] },
  { pattern: /leg curl/i, primary: 'hamstrings', secondary: [] },
  { pattern: /nordic curl/i, primary: 'hamstrings', secondary: [] },
  { pattern: /stiff.?leg/i, primary: 'hamstrings', secondary: ['glutes', 'back'] },

  // Glutes
  { pattern: /hip thrust/i, primary: 'glutes', secondary: ['hamstrings'] },
  { pattern: /glute/i, primary: 'glutes', secondary: [] },
  { pattern: /hip abduction/i, primary: 'glutes', secondary: [] },
  { pattern: /hip adduction/i, primary: 'glutes', secondary: [] },

  // Calves
  { pattern: /calf/i, primary: 'calves', secondary: [] },

  // Core
  { pattern: /crunch/i, primary: 'core', secondary: [] },
  { pattern: /sit.?up/i, primary: 'core', secondary: [] },
  { pattern: /plank/i, primary: 'core', secondary: [] },
  { pattern: /leg raise/i, primary: 'core', secondary: [] },
  { pattern: /knee raise/i, primary: 'core', secondary: [] },
  { pattern: /hanging/i, primary: 'core', secondary: [] },
  { pattern: /ab\b/i, primary: 'core', secondary: [] },
  { pattern: /russian twist/i, primary: 'core', secondary: [] },
  { pattern: /woodchop/i, primary: 'core', secondary: [] },
];

// Cardio patterns (tracked but not part of muscle scoring)
const CARDIO_PATTERNS = [
  /treadmill/i, /elliptical/i, /bike/i, /cycling/i, /rowing machine/i,
  /jump rope/i, /jumping jack/i, /burpee/i, /stair/i, /running/i, /walking/i,
];

function classifyExercise(name) {
  for (const c of CARDIO_PATTERNS) {
    if (c.test(name)) return { primary: 'cardio', secondary: [] };
  }
  for (const m of EXERCISE_MUSCLE_MAP) {
    if (m.pattern.test(name)) return { primary: m.primary, secondary: m.secondary };
  }
  return { primary: 'other', secondary: [] };
}

// ============================================================
// MUSCLE GROUP METADATA
// ============================================================
const MUSCLE_GROUPS = {
  chest:      { name: 'Chest',      icon: '', idealFreqDays: 4, color: '#f87171' },
  back:       { name: 'Back',       icon: '', idealFreqDays: 4, color: '#60a5fa' },
  shoulders:  { name: 'Shoulders',  icon: '', idealFreqDays: 4, color: '#c084fc' },
  biceps:     { name: 'Biceps',     icon: '', idealFreqDays: 5, color: '#34d399' },
  triceps:    { name: 'Triceps',    icon: '', idealFreqDays: 5, color: '#fbbf24' },
  quads:      { name: 'Quads',      icon: '', idealFreqDays: 4, color: '#fb923c' },
  hamstrings: { name: 'Hamstrings', icon: '', idealFreqDays: 5, color: '#f472b6' },
  glutes:     { name: 'Glutes',     icon: '', idealFreqDays: 5, color: '#a78bfa' },
  calves:     { name: 'Calves',     icon: '', idealFreqDays: 5, color: '#2dd4bf' },
  core:       { name: 'Core',       icon: '', idealFreqDays: 3, color: '#e879f9' },
};

// ============================================================
// SUGGESTED EXERCISES PER MUSCLE GROUP
// ============================================================
const EXERCISE_SUGGESTIONS = {
  chest: ['Bench Press (Barbell)', 'Incline Bench Press (Dumbbell)', 'Chest Fly (Machine)', 'Chest Dip'],
  back: ['Bent Over Row (Barbell)', 'Pull Up', 'Lat Pulldown (Cable)', 'Seated Row (Machine)'],
  shoulders: ['Overhead Press (Barbell)', 'Lateral Raise (Dumbbell)', 'Arnold Press (Dumbbell)'],
  biceps: ['Bicep Curl (Barbell)', 'Hammer Curl (Dumbbell)', 'Concentration Curl'],
  triceps: ['Triceps Pushdown', 'Triceps Extension (Cable)', 'Skullcrusher (Dumbbell)'],
  quads: ['Squat (Barbell)', 'Leg Press (Machine)', 'Front Squat', 'Lunge (Dumbbell)'],
  hamstrings: ['Romanian Deadlift (Barbell)', 'Seated Leg Curl (Machine)'],
  glutes: ['Hip Thrust (Barbell)', 'Glute Kickback (Machine)', 'Hip Thrust (Machine)'],
  calves: ['Standing Calf Raise', 'Seated Calf Raise'],
  core: ['Hanging Leg Raise', 'Crunch', 'Plank'],
};

// ============================================================
// BODY WEIGHT DATA (from CSV)
// ============================================================
const WEIGHT_DATA = [
  { date: '2026-01-18', value: 166.0 },
  { date: '2026-01-17', value: 164.4 },
  { date: '2025-11-30', value: 168.0 },
  { date: '2025-11-04', value: 167.1 },
  { date: '2025-11-01', value: 168.2 },
  { date: '2025-10-01', value: 169.0 },
  { date: '2025-09-12', value: 169.0 },
  { date: '2025-09-07', value: 168.0 },
  { date: '2025-07-15', value: 172.0 },
  { date: '2025-05-23', value: 174.2 },
  { date: '2025-05-15', value: 172.0 },
  { date: '2025-04-30', value: 173.0 },
  { date: '2022-04-08', value: 173.0 },
  { date: '2022-02-04', value: 147.6 },
  { date: '2022-01-26', value: 168.6 },
  { date: '2022-01-20', value: 169.0 },
  { date: '2022-01-09', value: 168.4 },
  { date: '2021-12-06', value: 167.2 },
  { date: '2021-11-20', value: 165.2 },
  { date: '2021-10-28', value: 168.8 },
  { date: '2021-10-27', value: 169.6 },
  { date: '2021-10-25', value: 170.4 },
  { date: '2021-10-22', value: 169.8 },
  { date: '2021-10-20', value: 172.0 },
  { date: '2021-10-19', value: 171.0 },
  { date: '2021-10-16', value: 168.8 },
  { date: '2021-10-11', value: 168.8 },
  { date: '2021-10-08', value: 168.8 },
  { date: '2021-09-26', value: 169.6 },
  { date: '2021-09-24', value: 167.8 },
  { date: '2021-09-23', value: 167.4 },
  { date: '2021-09-22', value: 168.4 },
  { date: '2021-09-20', value: 168.8 },
  { date: '2021-09-19', value: 170.6 },
  { date: '2021-09-18', value: 169.0 },
  { date: '2021-09-15', value: 168.8 },
  { date: '2021-09-14', value: 168.2 },
  { date: '2021-09-13', value: 168.4 },
  { date: '2021-09-12', value: 166.4 },
  { date: '2021-09-08', value: 167.6 },
  { date: '2021-09-01', value: 166.8 },
  { date: '2021-08-29', value: 165.6 },
  { date: '2021-08-28', value: 165.0 },
  { date: '2021-08-27', value: 165.0 },
  { date: '2021-08-26', value: 166.6 },
  { date: '2021-08-25', value: 165.8 },
  { date: '2021-08-23', value: 165.8 },
  { date: '2021-08-21', value: 165.2 },
  { date: '2021-08-16', value: 165.6 },
  { date: '2021-08-15', value: 165.8 },
  { date: '2021-08-14', value: 164.6 },
  { date: '2021-08-09', value: 165.4 },
  { date: '2021-08-06', value: 165.2 },
  { date: '2021-08-03', value: 167.6 },
  { date: '2021-07-31', value: 164.8 },
];

// ============================================================
// STATE
// ============================================================
let apiKey = localStorage.getItem('hevy_api_key') || '';
let workoutCache = null;
let muscleAnalysis = null;

// ============================================================
// API
// ============================================================
const API_BASE = 'https://api.hevyapp.com/v1';

async function fetchWorkouts(pageSize = 10, maxPages = 10) {
  const allWorkouts = [];
  let page = 1;
  let totalPages = 1;

  while (page <= totalPages && page <= maxPages) {
    updateLoading(`Fetching workouts (page ${page})...`);
    const resp = await fetch(`${API_BASE}/workouts?page=${page}&pageSize=${pageSize}`, {
      headers: { 'api-key': apiKey }
    });
    if (!resp.ok) throw new Error(`API error ${resp.status}: ${resp.statusText}`);
    const data = await resp.json();
    totalPages = data.page_count || 1;
    if (data.workouts) allWorkouts.push(...data.workouts);
    page++;
  }
  return allWorkouts;
}

async function fetchExerciseTemplates() {
  const templates = [];
  let page = 1;
  let totalPages = 1;

  while (page <= totalPages && page <= 20) {
    const resp = await fetch(`${API_BASE}/exercise_templates?page=${page}&pageSize=10`, {
      headers: { 'api-key': apiKey }
    });
    if (!resp.ok) break;
    const data = await resp.json();
    totalPages = data.page_count || 1;
    if (data.exercise_templates) templates.push(...data.exercise_templates);
    page++;
  }
  return templates;
}

// ============================================================
// ANALYSIS
// ============================================================
function analyzeWorkouts(workouts) {
  const now = new Date();
  const muscleStats = {};

  // Initialize all muscle groups
  for (const [key, meta] of Object.entries(MUSCLE_GROUPS)) {
    muscleStats[key] = {
      key,
      name: meta.name,
      color: meta.color,
      idealFreqDays: meta.idealFreqDays,
      lastTrained: null,
      daysSinceTrained: Infinity,
      totalSets30d: 0,
      totalVolume30d: 0,
      sessionCount30d: 0,
      exercises: new Set(),
    };
  }

  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

  for (const w of workouts) {
    const workoutDate = new Date(w.start_time || w.created_at);
    const isRecent = workoutDate >= thirtyDaysAgo;
    const musclesThisWorkout = new Set();

    for (const ex of (w.exercises || [])) {
      const exName = ex.title || ex.exercise_template_id || '';
      const classification = classifyExercise(exName);
      if (classification.primary === 'cardio' || classification.primary === 'other') continue;

      const allMuscles = [classification.primary, ...classification.secondary];

      for (const muscle of allMuscles) {
        if (!muscleStats[muscle]) continue;
        const stat = muscleStats[muscle];
        const isPrimary = muscle === classification.primary;

        // Track last trained date
        if (!stat.lastTrained || workoutDate > stat.lastTrained) {
          stat.lastTrained = workoutDate;
          stat.daysSinceTrained = Math.floor((now - workoutDate) / (1000 * 60 * 60 * 24));
        }

        if (isRecent) {
          const setCount = (ex.sets || []).length;
          // Primary muscles get full credit, secondary get half
          const weight = isPrimary ? 1.0 : 0.5;
          stat.totalSets30d += Math.round(setCount * weight);

          // Volume = sets × reps × weight
          for (const s of (ex.sets || [])) {
            const reps = s.reps || 0;
            const wt = s.weight_kg || 0;
            stat.totalVolume30d += reps * wt * weight;
          }

          stat.exercises.add(exName);
          musclesThisWorkout.add(muscle);
        }
      }
    }

    // Count sessions per muscle
    if (isRecent) {
      for (const m of musclesThisWorkout) {
        if (muscleStats[m]) muscleStats[m].sessionCount30d++;
      }
    }
  }

  return muscleStats;
}

function generateRecommendations(muscleStats) {
  const recs = [];

  for (const [key, stat] of Object.entries(muscleStats)) {
    // Score: higher = more urgent to train
    // Factors: days since trained, sets in last 30 days vs ideal
    const daysOverdue = Math.max(0, stat.daysSinceTrained - stat.idealFreqDays);
    const recencyScore = Math.min(stat.daysSinceTrained / stat.idealFreqDays, 3); // 0–3
    const idealSets30d = Math.round(30 / stat.idealFreqDays) * 4; // rough: sessions × 4 sets
    const volumeDeficit = Math.max(0, 1 - (stat.totalSets30d / idealSets30d)); // 0–1

    const score = (recencyScore * 0.6) + (volumeDeficit * 0.4);

    let urgency = 'low';
    if (stat.daysSinceTrained >= stat.idealFreqDays * 2) urgency = 'high';
    else if (stat.daysSinceTrained >= stat.idealFreqDays) urgency = 'med';

    recs.push({
      key,
      name: stat.name,
      score,
      urgency,
      daysSince: stat.daysSinceTrained,
      sets30d: stat.totalSets30d,
      detail: stat.daysSinceTrained === Infinity
        ? 'never trained'
        : `${stat.daysSinceTrained}d ago · ${stat.totalSets30d} sets/30d`,
    });
  }

  recs.sort((a, b) => b.score - a.score);
  return recs;
}

// ============================================================
// RENDERING
// ============================================================
function renderRecommendations(recs) {
  const container = document.getElementById('recommendations');
  // Show top 5 recommendations
  const top = recs.slice(0, 5);
  container.innerHTML = top.map((r, i) => `
    <div class="rec-item">
      <div class="rec-rank">${i + 1}</div>
      <div class="rec-info">
        <div class="rec-name">${r.name}</div>
        <div class="rec-detail">${r.detail}</div>
      </div>
      <div class="rec-urgency urgency-${r.urgency}">${r.urgency}</div>
    </div>
  `).join('');

  // Suggested exercises for top 3
  const exContainer = document.getElementById('suggested-exercises');
  const topKeys = top.slice(0, 3).map(r => r.key);
  let exHtml = '';
  for (const key of topKeys) {
    const suggestions = EXERCISE_SUGGESTIONS[key] || [];
    if (suggestions.length === 0) continue;
    exHtml += `<div style="margin-bottom:12px;">
      <div style="font-size:12px;font-weight:600;color:${MUSCLE_GROUPS[key].color};margin-bottom:6px;">${MUSCLE_GROUPS[key].name}</div>
      ${suggestions.map(s => `<div style="font-size:12px;color:var(--text-dim);padding:3px 0;">· ${s}</div>`).join('')}
    </div>`;
  }
  exContainer.innerHTML = exHtml;
}

function renderMuscleGrid(muscleStats) {
  const grid = document.getElementById('muscle-grid');
  const entries = Object.entries(muscleStats).sort((a, b) => b[1].daysSinceTrained - a[1].daysSinceTrained);

  // Find max sets for bar scaling
  const maxSets = Math.max(...entries.map(([, s]) => s.totalSets30d), 1);

  grid.innerHTML = entries.map(([key, stat]) => {
    const barPct = Math.round((stat.totalSets30d / maxSets) * 100);
    const daysText = stat.daysSinceTrained === Infinity ? 'never' : `${stat.daysSinceTrained}d ago`;
    return `
      <div class="muscle-cell">
        <div class="muscle-name" style="color:${stat.color}">${stat.name}</div>
        <div class="muscle-stat">${daysText} · ${stat.totalSets30d} sets</div>
        <div class="muscle-bar">
          <div class="muscle-bar-fill" style="width:${barPct}%;background:${stat.color}"></div>
        </div>
      </div>`;
  }).join('');
}

function renderRecentWorkouts(workouts) {
  const container = document.getElementById('recent-workouts');
  const recent = workouts.slice(0, 10);
  container.innerHTML = recent.map(w => {
    const date = new Date(w.start_time || w.created_at);
    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const exercises = (w.exercises || []).map(e => e.title || 'Unknown').join(', ');
    const totalSets = (w.exercises || []).reduce((sum, e) => sum + (e.sets || []).length, 0);
    return `
      <div class="workout-item">
        <div class="workout-title">${w.title || 'Workout'}</div>
        <div class="workout-meta">${dateStr} · ${totalSets} sets · ${exercises.substring(0, 60)}${exercises.length > 60 ? '...' : ''}</div>
      </div>`;
  }).join('');
}

function renderWeightChart() {
  // Show recent data (last 12 months)
  const cutoff = new Date();
  cutoff.setFullYear(cutoff.getFullYear() - 1);
  const recent = WEIGHT_DATA.filter(d => new Date(d.date) >= cutoff).reverse();

  if (recent.length === 0) return;

  const current = WEIGHT_DATA[0].value;
  const prev = WEIGHT_DATA.length > 1 ? WEIGHT_DATA[1].value : current;
  const delta = current - prev;

  document.getElementById('weight-current').textContent = current.toFixed(1);
  const deltaEl = document.getElementById('weight-delta');
  deltaEl.textContent = `${delta >= 0 ? '+' : ''}${delta.toFixed(1)}`;
  deltaEl.style.color = delta <= 0 ? 'var(--accent)' : 'var(--warn)';

  // Draw chart
  const canvas = document.getElementById('weight-canvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 120 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '120px';
  ctx.scale(dpr, dpr);

  const w = rect.width;
  const h = 120;
  const pad = { top: 10, bottom: 20, left: 0, right: 0 };

  const values = recent.map(d => d.value);
  const min = Math.min(...values) - 2;
  const max = Math.max(...values) + 2;

  const xStep = (w - pad.left - pad.right) / Math.max(recent.length - 1, 1);

  // Draw line
  ctx.beginPath();
  ctx.strokeStyle = '#4ade80';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';

  recent.forEach((d, i) => {
    const x = pad.left + i * xStep;
    const y = pad.top + (1 - (d.value - min) / (max - min)) * (h - pad.top - pad.bottom);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill area
  const lastX = pad.left + (recent.length - 1) * xStep;
  ctx.lineTo(lastX, h - pad.bottom);
  ctx.lineTo(pad.left, h - pad.bottom);
  ctx.closePath();
  const gradient = ctx.createLinearGradient(0, 0, 0, h);
  gradient.addColorStop(0, 'rgba(74, 222, 128, 0.15)');
  gradient.addColorStop(1, 'rgba(74, 222, 128, 0)');
  ctx.fillStyle = gradient;
  ctx.fill();

  // Dots on endpoints
  [0, recent.length - 1].forEach(i => {
    const x = pad.left + i * xStep;
    const y = pad.top + (1 - (recent[i].value - min) / (max - min)) * (h - pad.top - pad.bottom);
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#4ade80';
    ctx.fill();
  });

  // Labels
  ctx.fillStyle = '#777';
  ctx.font = '10px JetBrains Mono, monospace';
  ctx.textAlign = 'left';
  ctx.fillText(recent[0].date.substring(5), pad.left, h - 4);
  ctx.textAlign = 'right';
  ctx.fillText(recent[recent.length - 1].date.substring(5), w - pad.right, h - 4);
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(`tab-${tab}`).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(el => {
    el.classList.toggle('active', el.dataset.tab === tab);
  });
  if (tab === 'weight') {
    setTimeout(renderWeightChart, 50);
  }
}

// ============================================================
// APP LIFECYCLE
// ============================================================
function showScreen(screen) {
  ['setup-screen', 'loading-screen', 'dashboard'].forEach(id => {
    document.getElementById(id).classList.toggle('hidden', id !== screen);
  });
}

function updateLoading(text) {
  document.getElementById('loading-text').textContent = text;
}

function showError(msg) {
  const area = document.getElementById('error-area');
  area.innerHTML = `<div class="error-msg">${msg}</div>`;
}

async function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) return;
  apiKey = key;
  localStorage.setItem('hevy_api_key', key);
  await loadDashboard();
}

function resetApp() {
  if (confirm('Clear API key and reset?')) {
    localStorage.removeItem('hevy_api_key');
    apiKey = '';
    workoutCache = null;
    showScreen('setup-screen');
  }
}

async function refreshData() {
  await loadDashboard();
}

async function loadDashboard() {
  showScreen('loading-screen');

  try {
    updateLoading('Fetching workouts...');
    const workouts = await fetchWorkouts(10, 10);
    workoutCache = workouts;

    updateLoading('Analyzing...');
    const stats = analyzeWorkouts(workouts);
    muscleAnalysis = stats;
    const recs = generateRecommendations(stats);

    showScreen('dashboard');

    const now = new Date();
    document.getElementById('last-updated').textContent =
      `updated ${now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;

    renderRecommendations(recs);
    renderMuscleGrid(stats);
    renderRecentWorkouts(workouts);
    renderWeightChart();

  } catch (err) {
    console.error(err);
    if (err.message.includes('401') || err.message.includes('403')) {
      showScreen('setup-screen');
      document.getElementById('setup-error').textContent = 'Invalid API key. Check your key and try again.';
      document.getElementById('setup-error').classList.remove('hidden');
    } else {
      showScreen('dashboard');
      showError(`Failed to load: ${err.message}. Check your connection and try again.`);
    }
  }
}

// Boot
if (apiKey) {
  loadDashboard();
} else {
  showScreen('setup-screen');
}
</script>
</body>
</html>
